[gd_scene load_steps=9 format=3 uid="uid://7ffrm4yh2wri"]

[ext_resource type="Texture2D" uid="uid://b7hppg8ya3ukl" path="res://texture/new gun.png" id="2_dw03f"]
[ext_resource type="Script" uid="uid://cpbkwkr11puvg" path="res://guns/base/gun_sprite_script.gd" id="2_w1428"]
[ext_resource type="Texture2D" uid="uid://b7me73yu8krqw" path="res://texture/bubbles.png" id="4_dw03f"]
[ext_resource type="Script" uid="uid://cyco2pd7pm81l" path="res://guns/base/gpu_particles_2d.gd" id="4_w1428"]

[sub_resource type="GDScript" id="GDScript_dw03f"]
script/source = "class_name Gun extends Node2D

var button_time_held = 0.0

signal fire_signal
signal fire_particle_signal

enum GUN_TYPE {AUTOMATIC = 1, SHOTGUN = 10}

@export var automatic_acceleration : float = 30.0
@export var shotgun_acceleration : float = 100.0
@export var particle_damage : int = 25

@onready var character : BubbleCharacter = get_parent()

var direction : Vector2
var particles_area: Area2D
var is_firing: bool = false

func _ready():
	fire_signal.connect(character.handle_fire_event)
	setup_damage_detection()

func setup_damage_detection() -> void:
	particles_area = Area2D.new()
	particles_area.name = \"GunDamageArea\"
	add_child(particles_area)
	
	var collision_shape = CollisionShape2D.new()
	var shape = RectangleShape2D.new()
	shape.size = Vector2(100, 50) 
	collision_shape.shape = shape
	particles_area.add_child(collision_shape)
	
	particles_area.position = Vector2(50, 0) 
	particles_area.body_entered.connect(_on_damage_area_body_entered)
	particles_area.monitoring = false

func calc_held_time(delta: float, button_time_held: float) -> float:
	return button_time_held - delta

func check_if_shot_fired(button_time_held: float, direction : Vector2, type: GUN_TYPE) -> float:
	if type == GUN_TYPE.AUTOMATIC and button_time_held < 0:
		fire_signal.emit(automatic_acceleration, direction)
		fire_particle_signal.emit(0.2)
		start_damage_detection(0.2)
		return 0.1
	if type == GUN_TYPE.SHOTGUN and button_time_held < 0:
		fire_signal.emit(shotgun_acceleration, direction)
		fire_particle_signal.emit(0.05)
		start_damage_detection(0.05)
		return 1.5
	return button_time_held

func start_damage_detection(duration: float) -> void:
	is_firing = true
	particles_area.monitoring = true

	# таймер до отключения дамага
	var timer = Timer.new()
	timer.wait_time = duration
	timer.one_shot = true
	add_child(timer)
	timer.timeout.connect(stop_damage_detection)
	timer.timeout.connect(timer.queue_free)
	timer.start()

func stop_damage_detection() -> void:
	is_firing = false
	particles_area.monitoring = false

func _on_damage_area_body_entered(body: Node2D) -> void:
	if body is Enemy and is_firing:
		body.take_damage(particle_damage)
		print(\"Урон: \", particle_damage)

func _physics_process(delta) -> void:
	button_time_held = clamp(calc_held_time(delta, button_time_held), -1, 1)
	if Input.is_action_pressed(\"click\"):
		button_time_held = check_if_shot_fired(button_time_held, -direction, GUN_TYPE.AUTOMATIC)

var radius := 32.0

func _process(delta: float) -> void:
	direction = (get_global_mouse_position() - get_parent().global_position).normalized()
	position = direction * radius
	rotation = direction.angle()
	
	if particles_area:
		particles_area.rotation = 0 
"

[sub_resource type="CanvasItemMaterial" id="CanvasItemMaterial_pg37a"]
particles_animation = true
particles_anim_h_frames = 6
particles_anim_v_frames = 4
particles_anim_loop = false

[sub_resource type="AtlasTexture" id="AtlasTexture_yfr3y"]
atlas = ExtResource("4_dw03f")
region = Rect2(0, 0, 78, 52)

[sub_resource type="ParticleProcessMaterial" id="ParticleProcessMaterial_14d2b"]
particle_flag_disable_z = true
spread = 0.0
initial_velocity_min = 500.0
initial_velocity_max = 500.0
gravity = Vector3(0, -98, 0)
anim_offset_max = 1.0
turbulence_enabled = true
turbulence_noise_strength = 1.4
turbulence_noise_scale = 4.0
turbulence_noise_speed_random = 2.4

[node name="Gun (Node2D)" type="Node2D"]
script = SubResource("GDScript_dw03f")

[node name="GunSprite" type="Sprite2D" parent="."]
texture = ExtResource("2_dw03f")
script = ExtResource("2_w1428")

[node name="GPUParticles2D" type="GPUParticles2D" parent="GunSprite"]
unique_name_in_owner = true
material = SubResource("CanvasItemMaterial_pg37a")
position = Vector2(13, -1)
emitting = false
amount = 72
texture = SubResource("AtlasTexture_yfr3y")
lifetime = 2.0
process_material = SubResource("ParticleProcessMaterial_14d2b")
script = ExtResource("4_w1428")
